<script>
/* Robust tab switching + calculation logic */

/* Utility: try to extract target id from a button's onclick attribute */
function extractTargetFromOnclick(btn){
  try{
    const onclick = btn.getAttribute && btn.getAttribute('onclick');
    if(!onclick) return null;
    const m = onclick.match(/switchTab\(\s*['"]([^'"]+)['"]/);
    return m ? m[1] : null;
  }catch(e){
    return null;
  }
}

/* switchTab can be called as switchTab('id', event) or switchTab(event) from inline handlers.
   It always resolves a string id and then activates the matching tab and content. */
function switchTab(idOrEvent, evt){
  try{
    let id = idOrEvent;
    // if first arg is an Event (or the event object), try to find the id from currentTarget/dataset/onclick
    if(typeof idOrEvent !== 'string'){
      const ev = idOrEvent || evt;
      const btn = (ev && ev.currentTarget) || (ev && ev.target) || null;
      if(btn){
        id = btn.dataset && btn.dataset.target ? btn.dataset.target : extractTargetFromOnclick(btn);
      }
    }
    if(!id) return;
    // prevent default if possible
    if(evt && typeof evt.preventDefault === 'function') evt.preventDefault();

    // deactivate tabs and contents
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    // activate content
    const el = document.getElementById(id);
    if(el) el.classList.add('active');

    // activate matching tab button(s) (prefer data-target)
    const btnByData = document.querySelector('.tab[data-target="' + id + '"]');
    if(btnByData) btnByData.classList.add('active');
    else {
      // fallback: find tab with onclick referencing that id
      const btnByOnclick = Array.from(document.querySelectorAll('.tab')).find(b => {
        const onclick = b.getAttribute && b.getAttribute('onclick');
        return onclick && onclick.indexOf("switchTab('" + id + "'") !== -1 || onclick && onclick.indexOf('switchTab("' + id + '"') !== -1;
      });
      if(btnByOnclick) btnByOnclick.classList.add('active');
    }
  }catch(e){
    console.error('switchTab error:', e);
  }
}

/* Calculation logic (defensive) */
function calculate(){
  try{
    const get = id => {
      const el = document.getElementById(id);
      if(!el) return 0;
      const v = Number(el.value);
      return isNaN(v) ? 0 : v;
    };

    const ADT = get('adt');
    const lanesTotal = Math.max(1, get('lanesTotal') || 1);
    const truckPercent = (get('truckPercent') || 0) / 100;
    const avgOccupancy = get('avgOccupancy') || 1;

    const annualIncidents = get('annualIncidents');
    const avgLanesBlocked = Math.max(0.0001, get('avgLanesBlocked') || 1);
    const baselineClearanceMin = Math.max(1, get('baselineClearanceMin') || 1);
    const timeSavedMin = get('timeSavedMin');

    const votPassenger = get('votPassenger');
    const votCommercial = get('votCommercial');
    const effectivenessMultiplier = Math.max(0, Math.min(1, get('effectivenessMultiplier') || 1));

    const droneEquipmentCost = get('droneEquipmentCost');
    const dronePersonnelCost = get('dronePersonnelCost');
    const droneTrainingOverhead = get('droneTrainingOverhead');

    // vehicles affected per hour (simple average)
    const vehiclesPerHour = (ADT / 24) * (avgLanesBlocked / lanesTotal);
    const passengerVehiclesPerHour = vehiclesPerHour * (1 - truckPercent);
    const commercialVehiclesPerHour = vehiclesPerHour * truckPercent;

    const effectiveTimeSavedMin = timeSavedMin * effectivenessMultiplier;
    const effectiveTimeSavedHr = effectiveTimeSavedMin / 60;

    const passengerDelay = passengerVehiclesPerHour * avgOccupancy * votPassenger * effectiveTimeSavedHr;
    const commercialDelay = commercialVehiclesPerHour * votCommercial * effectiveTimeSavedHr;
    const totalDelayPerIncident = passengerDelay + commercialDelay;

    const secondaryCrashProb = get('secondaryCrashProb');
    const avgSecondaryCost = get('avgSecondaryCost');
    // scale secondary savings by fraction of clearance time saved
    const secondaryCostPerIncident = secondaryCrashProb * avgSecondaryCost * (effectiveTimeSavedMin / baselineClearanceMin);

    const annualSavings = (totalDelayPerIncident + secondaryCostPerIncident) * annualIncidents;

    const annualDroneCosts = droneEquipmentCost + dronePersonnelCost + droneTrainingOverhead;
    const netAnnualBenefit = annualSavings - annualDroneCosts;
    const roi = annualDroneCosts === 0 ? (netAnnualBenefit > 0 ? Infinity : -Infinity) : (netAnnualBenefit / annualDroneCosts);
    const paybackYears = annualSavings > 0 ? (annualDroneCosts / annualSavings) : (netAnnualBenefit > 0 ? 0 : Infinity);

    const fmtMoney = v => isFinite(v) ? ('$' + Number(v).toLocaleString(undefined, {maximumFractionDigits:2})) : '-';
    const fmtMoney0 = v => isFinite(v) ? ('$' + Math.round(v).toLocaleString()) : '-';
    const fmtPercent = v => isFinite(v) ? (Math.round(v * 100) + '%') : '-';

    const set = (id, txt) => {
      const e = document.getElementById(id);
      if(e) e.textContent = txt;
    };

    set('passengerDelay', fmtMoney(passengerDelay));
    set('commercialDelay', fmtMoney(commercialDelay));
    set('totalDelay', fmtMoney(totalDelayPerIncident));
    set('secondaryCost', fmtMoney(secondaryCostPerIncident));
    set('responseCost', fmtMoney(0));
    set('environmentalCost', fmtMoney(0));
    set('costPerIncident', fmtMoney(totalDelayPerIncident + secondaryCostPerIncident));

    set('annualBaseline', fmtMoney0((totalDelayPerIncident + secondaryCostPerIncident) * annualIncidents));
    set('annualSavings', fmtMoney0(annualSavings));
    set('annualDroneCosts', fmtMoney0(annualDroneCosts));
    set('netBenefit', fmtMoney0(netAnnualBenefit));
    set('roiValue', isFinite(roi) ? (Math.round(roi * 100) + '%') : (roi === Infinity ? 'âˆž' : '-'));
    set('netBenefitValue', fmtMoney0(netAnnualBenefit));
    set('paybackValue', isFinite(paybackYears) ? (paybackYears.toFixed(1) + ' years') : '-');

    set('laneClosureFactor', fmtPercent(avgLanesBlocked / lanesTotal));
    set('vehiclesAffected', Math.round(vehiclesPerHour));
    set('reductionFactor', fmtPercent(effectivenessMultiplier));
    set('baselineCost', fmtMoney(totalDelayPerIncident + secondaryCostPerIncident));
    set('savingsPerIncident', fmtMoney(totalDelayPerIncident + secondaryCostPerIncident));
    set('costReduction', fmtPercent(effectivenessMultiplier));

    const breakEvenIncidents = annualDroneCosts === 0 ? 0 : Math.ceil(annualDroneCosts / Math.max(1, (totalDelayPerIncident + secondaryCostPerIncident)));
    set('breakEvenIncidents', breakEvenIncidents);
    set('annualIncidentsDisplay', annualIncidents);
    const margin = annualIncidents === 0 ? 0 : Math.max(0, ((annualIncidents - breakEvenIncidents) / Math.max(1, annualIncidents)));
    set('marginSafety', fmtPercent(margin));

  }catch(e){
    console.error('calculate() error:', e);
  }
}

/* Initialization: set data-targets, attach listeners, and run initial calculate */
document.addEventListener('DOMContentLoaded', function(){
  try{
    // Attach click handlers to tabs and set dataset.target for reliability
    document.querySelectorAll('.tab').forEach(btn => {
      // prefer explicit data-target if present
      let target = btn.dataset && btn.dataset.target ? btn.dataset.target : null;
      if(!target) target = extractTargetFromOnclick(btn);

      // fallback using button text
      if(!target){
        const txt = (btn.textContent || '').trim().toLowerCase();
        if(txt.startsWith('calculator')) target = 'calculator';
        else if(txt.startsWith('results')) target = 'results';
        else if(txt.includes('dictionary') || txt.includes('data')) target = 'dictionary';
        else if(txt.startsWith('methodology')) target = 'methodology';
      }

      if(target) btn.dataset.target = target;

      // prevent double-calls if inline onclick exists; rely on our handler
      btn.addEventListener('click', function(e){
        e.preventDefault();
        const tgt = btn.dataset.target;
        if(tgt) switchTab(tgt);
        else {
          // last resort: call switchTab with event object (function handles it)
          switchTab(e);
        }
      });
    });

    // Hook inputs to recalc on change for responsiveness
    document.querySelectorAll('input').forEach(i => {
      i.addEventListener('input', calculate);
    });

    // Initial calculation
    calculate();

    // Ensure initial active tab state is consistent (in case HTML had active class)
    const activeContent = document.querySelector('.tab-content.active');
    if(activeContent){
      const id = activeContent.id;
      // mark matching tab active
      const btn = document.querySelector('.tab[data-target="' + id + '"]') || document.querySelector('.tab[onclick*="switchTab(\'' + id + '\'"]') || null;
      if(btn) btn.classList.add('active');
    } else {
      // default to calculator
      switchTab('calculator');
    }

  }catch(e){
    console.error('Initialization error:', e);
  }
});
</script>