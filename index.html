<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Response ROI Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f7fa; padding: 20px; color: #2d3748; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; padding: 30px; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .tabs { display: flex; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .tab { padding: 16px 24px; cursor: pointer; border: none; background: none; font-size: 15px; font-weight: 500; color: #64748b; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab:hover { color: #2563eb; background: #f1f5f9; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; background: white; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .input-section { margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #e2e8f0; }
        .section-title { font-size: 18px; font-weight: 600; color: #1e40af; margin-bottom: 20px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .input-field { display: flex; flex-direction: column; }
        .input-field label { font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px; }
        .input-wrapper { display: flex; align-items: center; gap: 8px; }
        .input-field input { flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .input-field input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .unit { font-size: 13px; color: #6b7280; min-width: 80px; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .result-card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; }
        .result-card h3 { font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 16px; }
        .result-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
        .result-row:last-child { border-bottom: none; }
        .result-label { font-size: 14px; color: #6b7280; }
        .result-value { font-weight: 600; color: #1f2937; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 24px; background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%); border-radius: 8px; }
        .summary-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .summary-label { font-size: 13px; color: #6b7280; margin-bottom: 8px; }
        .summary-value { font-size: 32px; font-weight: 700; }
        .positive { color: #059669; }
        .negative { color: #dc2626; }
        .neutral { color: #2563eb; }
        .alert { background: #dbeafe; border-left: 4px solid #2563eb; padding: 16px; border-radius: 6px; margin-top: 20px; }
        .alert h4 { font-size: 15px; font-weight: 600; color: #1e40af; margin-bottom: 8px; }
        .alert ul { list-style: none; font-size: 14px; color: #1e3a8a; }
        .alert li { margin: 6px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        thead { background: #f8fafc; }
        th { text-align: left; padding: 12px; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; font-size: 14px; border-bottom: 1px solid #f1f5f9; }
        .category-row { background: #f0f9ff; font-weight: 600; }
        .methodology-section { margin-bottom: 30px; }
        .methodology-section h3 { font-size: 18px; font-weight: 600; color: #1e40af; margin-bottom: 12px; }
        .methodology-section p { font-size: 14px; line-height: 1.6; color: #4b5563; margin-bottom: 12px; }
        .methodology-section ul { font-size: 14px; line-height: 1.6; color: #4b5563; margin-bottom: 12px; padding-left: 20px; }
        .formula { background: #f8fafc; padding: 16px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; margin: 12px 0; overflow-x: auto; white-space: pre; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Disabled Vehicle Drone Response ROI Calculator</h1>
            <p>Economic Analysis for Autonomous Incident Response on High-Volume Roadways</p>
        </div>

        <div class="tabs">
            <!-- FIX: type="button" prevents accidental submits/reloads in more complex layouts -->
            <button type="button" class="tab active" onclick="switchTab('calculator', event)">Calculator</button>
            <button type="button" class="tab" onclick="switchTab('results', event)">Results & Analysis</button>
            <button type="button" class="tab" onclick="switchTab('dictionary', event)">Data Dictionary</button>
            <button type="button" class="tab" onclick="switchTab('methodology', event)">Methodology</button>
        </div>

        <div id="calculator" class="tab-content active">
            <div class="input-section">
                <h3 class="section-title">Roadway Characteristics</h3>
                <div class="input-grid">
                    <div class="input-field">
                        <label>Average Daily Traffic (ADT)</label>
                        <div class="input-wrapper">
                            <input type="number" id="adt" value="100000" oninput="calculate()">
                            <span class="unit">vehicles/day</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Total Number of Lanes</label>
                        <div class="input-wrapper">
                            <input type="number" id="lanesTotal" value="4" oninput="calculate()">
                            <span class="unit">lanes</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Commercial Vehicle %</label>
                        <div class="input-wrapper">
                            <input type="number" id="truckPercent" value="15" oninput="calculate()">
                            <span class="unit">%</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Average Vehicle Occupancy</label>
                        <div class="input-wrapper">
                            <input type="number" id="avgOccupancy" value="1.6" step="0.1" oninput="calculate()">
                            <span class="unit">persons/vehicle</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3 class="section-title">Incident Data</h3>
                <div class="input-grid">
                    <div class="input-field">
                        <label>Annual Incidents</label>
                        <div class="input-wrapper">
                            <input type="number" id="annualIncidents" value="500" oninput="calculate()">
                            <span class="unit">incidents/year</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Average Lanes Blocked</label>
                        <div class="input-wrapper">
                            <input type="number" id="avgLanesBlocked" value="1" oninput="calculate()">
                            <span class="unit">lanes</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Baseline Clearance Time</label>
                        <div class="input-wrapper">
                            <input type="number" id="baselineClearanceMin" value="35" oninput="calculate()">
                            <span class="unit">minutes</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Time Saved with Drones</label>
                        <div class="input-wrapper">
                            <input type="number" id="timeSavedMin" value="12" oninput="calculate()">
                            <span class="unit">minutes</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3 class="section-title">Economic Values</h3>
                <div class="input-grid">
                    <div class="input-field">
                        <label>Economic Cost of Delay <a href="https://ops.fhwa.dot.gov/tim/docs/EDC-6_Factsheet_TIM_UnmannedAircraft_v2_508.pdf" target="_blank" rel="noopener noreferrer" style="font-size: 12px; font-weight: 600; color: #2563eb; text-decoration: none;">[FHWA UAS TIM]</a></label>
                        <div class="input-wrapper">
                            <input type="text" id="delayCostPerMin" value="$350" disabled>
                            <span class="unit">$/minute</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Secondary Crash Probability</label>
                        <div class="input-wrapper">
                            <input type="number" id="secondaryCrashProb" value="0.03" step="0.01" oninput="calculate()">
                            <span class="unit">probability</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Avg Secondary Crash Cost</label>
                        <div class="input-wrapper">
                            <input type="number" id="avgSecondaryCost" value="125000" oninput="calculate()">
                            <span class="unit">$</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Emission Cost per Vehicle-Hour</label>
                        <div class="input-wrapper">
                            <input type="number" id="emissionCostPerVehHr" value="0.85" step="0.05" oninput="calculate()">
                            <span class="unit">$</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3 class="section-title">Response Costs</h3>
                <div class="input-grid">
                    <div class="input-field">
                        <label>Baseline Detection Time</label>
                        <div class="input-wrapper">
                            <input type="number" id="baselineDetectionMin" value="8" oninput="calculate()">
                            <span class="unit">minutes</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Baseline Verification Time</label>
                        <div class="input-wrapper">
                            <input type="number" id="baselineVerificationMin" value="5" oninput="calculate()">
                            <span class="unit">minutes</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Baseline Dispatch Time</label>
                        <div class="input-wrapper">
                            <input type="number" id="baselineDispatchMin" value="7" oninput="calculate()">
                            <span class="unit">minutes</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Response Hourly Cost</label>
                        <div class="input-wrapper">
                            <input type="number" id="responseHourlyCost" value="150" oninput="calculate()">
                            <span class="unit">$/hour</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3 class="section-title">Drone Program Costs (Annual)</h3>
                <div class="input-grid">
                    <div class="input-field">
                        <label>Equipment & Maintenance</label>
                        <div class="input-wrapper">
                            <input type="number" id="droneEquipmentCost" value="100897" oninput="calculate()">
                            <span class="unit">$/year</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Personnel & Operations</label>
                        <div class="input-wrapper">
                            <input type="number" id="dronePersonnelCost" value="80000" oninput="calculate()">
                            <span class="unit">$/year</span>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Training & Overhead</label>
                        <div class="input-wrapper">
                            <input type="number" id="droneTrainingOverhead" value="13000" oninput="calculate()">
                            <span class="unit">$/year</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3 class="section-title">Effectiveness Parameters</h3>
                <div class="input-grid">
                    <div class="input-field">
                        <label>Effectiveness Multiplier</label>
                        <div class="input-wrapper">
                            <input type="number" id="effectivenessMultiplier" value="0.5" step="0.1" oninput="calculate()">
                            <span class="unit">factor (0-1)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results" class="tab-content">
            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">Executive Summary</h2>
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-label">Return on Investment</div>
                    <div class="summary-value" id="roiValue">-</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Net Annual Benefit</div>
                    <div class="summary-value" id="netBenefitValue">-</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Payback Period</div>
                    <div class="summary-value neutral" id="paybackValue">-</div>
                </div>
            </div>

            <div class="results-grid">
                <div class="result-card">
                    <h3>Cost Breakdown per Incident</h3>
                    <div class="result-row">
                        <span class="result-label">Total Delay Cost</span>
                        <span class="result-value" id="totalDelay">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Secondary Incident Cost</span>
                        <span class="result-value" id="secondaryCost">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Response Cost</span>
                        <span class="result-value" id="responseCost">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Environmental Cost</span>
                        <span class="result-value" id="environmentalCost">$0</span>
                    </div>
                    <div class="result-row" style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 8px;">
                        <span class="result-label" style="font-weight: 700;">Total Cost per Incident</span>
                        <span class="result-value" style="color: #2563eb;" id="costPerIncident">$0</span>
                    </div>
                </div>

                <div class="result-card">
                    <h3>Annual Financial Analysis</h3>
                    <div class="result-row">
                        <span class="result-label">Annual Baseline Cost</span>
                        <span class="result-value" style="color: #dc2626;" id="annualBaseline">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Annual Savings from Drones</span>
                        <span class="result-value" style="color: #059669;" id="annualSavings">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Annual Drone Program Costs</span>
                        <span class="result-value" style="color: #dc2626;" id="annualDroneCosts">$0</span>
                    </div>
                    <div class="result-row" style="background: #f0fdf4; padding: 12px; border-radius: 6px; margin-top: 8px;">
                        <span class="result-label" style="font-weight: 700;">Net Annual Benefit</span>
                        <span class="result-value" id="netBenefit">$0</span>
                    </div>
                </div>
            </div>

            <div class="results-grid">
                <div class="result-card">
                    <h3>Operational Metrics</h3>
                    <div class="result-row">
                        <span class="result-label">Lane Closure Factor</span>
                        <span class="result-value" id="laneClosureFactor">0%</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Vehicles Affected/Hour</span>
                        <span class="result-value" id="vehiclesAffected">0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Reduction Factor</span>
                        <span class="result-value" id="reductionFactor">0%</span>
                    </div>
                </div>

                <div class="result-card">
                    <h3>Per Incident Impact</h3>
                    <div class="result-row">
                        <span class="result-label">Baseline Cost</span>
                        <span class="result-value" id="baselineCost">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Savings per Incident</span>
                        <span class="result-value" style="color: #059669;" id="savingsPerIncident">$0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Cost Reduction</span>
                        <span class="result-value" id="costReduction">0%</span>
                    </div>
                </div>

                <div class="result-card">
                    <h3>Break-Even Analysis</h3>
                    <div class="result-row">
                        <span class="result-label">Break-Even Incidents</span>
                        <span class="result-value" id="breakEvenIncidents">0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Annual Incidents</span>
                        <span class="result-value" id="annualIncidentsDisplay">0</span>
                    </div>
                    <div class="result-row">
                        <span class="result-label">Margin of Safety</span>
                        <span class="result-value" id="marginSafety">0%</span>
                    </div>
                </div>
            </div>

            <div class="alert">
                <h4>Interpretation Notes</h4>
                <ul>
                    <li>A positive ROI indicates the drone program generates more value than it costs</li>
                    <li>Break-even incidents show the minimum number of incidents needed to justify the investment</li>
                    <li>Consider sensitivity analysis by adjusting key variables like time saved and effectiveness multiplier</li>
                    <li>These calculations exclude potential benefits like improved safety culture and reduced litigation risk</li>
                </ul>
            </div>
        </div>

        <div id="dictionary" class="tab-content">
            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">Data Dictionary</h2>
            <table>
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Definition</th>
                        <th>Units</th>
                        <th>Typical Range</th>
                        <th>Data Source</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="category-row">
                        <td colspan="5">Roadway Characteristics</td>
                    </tr>
                    <tr>
                        <td><strong>ADT</strong></td>
                        <td>Average Daily Traffic - total vehicle count per day</td>
                        <td>vehicles/day</td>
                        <td>20,000 - 300,000</td>
                        <td>State DOT traffic counts</td>
                    </tr>
                    <tr>
                        <td><strong>Total Lanes</strong></td>
                        <td>Number of through lanes in one direction</td>
                        <td>lanes</td>
                        <td>2 - 6</td>
                        <td>Roadway design plans</td>
                    </tr>
                    <tr>
                        <td><strong>Truck Percent</strong></td>
                        <td>Percentage of commercial vehicles</td>
                        <td>%</td>
                        <td>10 - 25%</td>
                        <td>Traffic classification studies</td>
                    </tr>
                    <tr class="category-row">
                        <td colspan="5">Economic Values</td>
                    </tr>
                    <tr>
                        <td><strong>Economic Cost of Delay</strong></td>
                        <td>Estimated fiscal impact of road closures (fixed)</td>
                        <td>$/minute</td>
                        <td>$350</td>
                        <td><a href="https://ops.fhwa.dot.gov/tim/docs/EDC-6_Factsheet_TIM_UnmannedAircraft_v2_508.pdf" target="_blank" rel="noopener noreferrer">Unmanned Aircraft Systems FOR TRAFFIC INCIDENT MANAGEMENT</a></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="methodology" class="tab-content">
            <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">Methodology</h2>

            <div class="methodology-section">
                <h3>Overview</h3>
                <p>This calculator estimates the return on investment for deploying autonomous drones to provide early intelligence to road crews and first responders during disabled vehicle incidents on high-volume roadways.</p>
            </div>

            <div class="methodology-section">
                <h3>Core Formula</h3>
                <div class="formula">ROI = (Annual Savings - Annual Drone Costs) / Annual Drone Costs</div>
                <p>Annual Savings are estimated from reduced delay costs and reduced secondary incident costs. Drone costs are entered as annual program costs.</p>
            </div>

            <div class="methodology-section">
                <h3>Notes</h3>
                <ul>
                    <li>Delay cost per incident is driven by lane closure factor, time saved, and the economic cost of delay per minute.</li>
                    <li>Secondary incident savings scale with the fraction of clearance time saved and the effectiveness multiplier.</li>
                    <li>Environmental and response costs are displayed but can be refined further depending on your model assumptions.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // SIMPLE, RELIABLE TAB SWITCHING (no inference, no extra listeners)
        function switchTab(tabId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const target = document.getElementById(tabId);
            if (target) target.classList.add('active');

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        // Defensive calculator so all oninput="calculate()" calls work
        function calculate() {
            try {
                const getNum = (id, fallback = 0) => {
                    const el = document.getElementById(id);
                    if (!el) return fallback;
                    const n = Number(el.value);
                    return Number.isFinite(n) ? n : fallback;
                };

                // Inputs (from your HTML)
                const ADT = getNum('adt', 0);
                const lanesTotal = Math.max(1, getNum('lanesTotal', 1));
                const truckPercent = Math.min(100, Math.max(0, getNum('truckPercent', 0))) / 100;
                const avgOccupancy = Math.max(0, getNum('avgOccupancy', 1));

                const annualIncidents = Math.max(0, getNum('annualIncidents', 0));
                const avgLanesBlocked = Math.max(0, getNum('avgLanesBlocked', 1));
                const baselineClearanceMin = Math.max(1, getNum('baselineClearanceMin', 1));
                const timeSavedMin = Math.max(0, getNum('timeSavedMin', 0));

                const delayCostPerMin = 350;

                const secondaryCrashProb = Math.max(0, getNum('secondaryCrashProb', 0));
                const avgSecondaryCost = Math.max(0, getNum('avgSecondaryCost', 0));

                const emissionCostPerVehHr = Math.max(0, getNum('emissionCostPerVehHr', 0));

                const responseHourlyCost = Math.max(0, getNum('responseHourlyCost', 0));
                // These exist in the HTML; we don't model drone time-to-response savings explicitly here,
                // but we keep the fields available for later refinement.
                const baselineDetectionMin = Math.max(0, getNum('baselineDetectionMin', 0));
                const baselineVerificationMin = Math.max(0, getNum('baselineVerificationMin', 0));
                const baselineDispatchMin = Math.max(0, getNum('baselineDispatchMin', 0));

                const droneEquipmentCost = Math.max(0, getNum('droneEquipmentCost', 0));
                const dronePersonnelCost = Math.max(0, getNum('dronePersonnelCost', 0));
                const droneTrainingOverhead = Math.max(0, getNum('droneTrainingOverhead', 0));

                const effectivenessMultiplier = Math.max(0, Math.min(1, getNum('effectivenessMultiplier', 1)));

                // Core intermediate values
                const laneClosureFactor = Math.min(1, Math.max(0, (avgLanesBlocked / lanesTotal)));
                const vehiclesPerHour = ADT / 24;
                const vehiclesAffectedPerHour = vehiclesPerHour * laneClosureFactor;

                const baselineDurationHours = baselineClearanceMin / 60;
                const effectiveTimeSavedMin = Math.max(0, Math.min(timeSavedMin, baselineClearanceMin));
                const reductionFactor = Math.min(1, Math.max(0, (effectiveTimeSavedMin / baselineClearanceMin) * effectivenessMultiplier));

                // Per-incident baseline costs
                const totalDelayCost = delayCostPerMin * baselineClearanceMin * laneClosureFactor;
                const secondaryCost = secondaryCrashProb * avgSecondaryCost;

                const totalResponseMinutes = baselineDetectionMin + baselineVerificationMin + baselineDispatchMin + baselineClearanceMin;
                const responseHours = totalResponseMinutes / 60;
                const responseCost = responseHours * responseHourlyCost;

                const environmentalCost = vehiclesAffectedPerHour * baselineDurationHours * emissionCostPerVehHr;

                const costPerIncident = totalDelayCost + secondaryCost + responseCost + environmentalCost;

                // Savings with drone program
                const savingsPerIncident = costPerIncident * reductionFactor;
                const annualBaselineCost = costPerIncident * annualIncidents;
                const annualSavings = savingsPerIncident * annualIncidents;

                const annualDroneCosts = droneEquipmentCost + dronePersonnelCost + droneTrainingOverhead;
                const netAnnualBenefit = annualSavings - annualDroneCosts;

                const roi = annualDroneCosts === 0
                    ? (netAnnualBenefit > 0 ? Infinity : (netAnnualBenefit < 0 ? -Infinity : 0))
                    : (netAnnualBenefit / annualDroneCosts);

                const paybackYears = annualSavings > 0 ? (annualDroneCosts / annualSavings) : Infinity;

                const fmtMoney = (v) => Number.isFinite(v) ? ('$' + v.toLocaleString(undefined, { maximumFractionDigits: 2 })) : '-';
                const fmtMoney0 = (v) => Number.isFinite(v) ? ('$' + Math.round(v).toLocaleString()) : '-';
                const fmtPercent0 = (v) => Number.isFinite(v) ? (Math.round(v * 100) + '%') : '-';

                const setText = (id, txt) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = txt;
                };

                // Results: per-incident
                setText('totalDelay', fmtMoney(totalDelayCost));
                setText('secondaryCost', fmtMoney(secondaryCost));
                setText('responseCost', fmtMoney(responseCost));
                setText('environmentalCost', fmtMoney(environmentalCost));
                setText('costPerIncident', fmtMoney(costPerIncident));

                // Annual
                setText('annualBaseline', fmtMoney0(annualBaselineCost));
                setText('annualSavings', fmtMoney0(annualSavings));
                setText('annualDroneCosts', fmtMoney0(annualDroneCosts));
                setText('netBenefit', fmtMoney0(netAnnualBenefit));
                setText('netBenefitValue', fmtMoney0(netAnnualBenefit));

                // Summary widgets
                const roiEl = document.getElementById('roiValue');
                if (roiEl) {
                    roiEl.textContent = (roi === Infinity) ? 'âˆž' : (Number.isFinite(roi) ? (Math.round(roi * 100) + '%') : '-');
                    roiEl.classList.remove('positive', 'negative', 'neutral');
                    roiEl.classList.add(netAnnualBenefit > 0 ? 'positive' : (netAnnualBenefit < 0 ? 'negative' : 'neutral'));
                }

                const paybackEl = document.getElementById('paybackValue');
                if (paybackEl) {
                    paybackEl.textContent = Number.isFinite(paybackYears) ? (paybackYears.toFixed(1) + ' years') : '-';
                }

                // Operational metrics
                setText('laneClosureFactor', fmtPercent0(laneClosureFactor));
                setText('vehiclesAffected', Number.isFinite(vehiclesAffectedPerHour) ? Math.round(vehiclesAffectedPerHour).toLocaleString() : '0');
                setText('reductionFactor', fmtPercent0(reductionFactor));

                // Per incident impact boxes
                setText('baselineCost', fmtMoney(costPerIncident));
                setText('savingsPerIncident', fmtMoney(savingsPerIncident));
                setText('costReduction', fmtPercent0(reductionFactor));

                // Break-even / margin
                const breakEvenIncidents = (savingsPerIncident > 0) ? Math.ceil(annualDroneCosts / savingsPerIncident) : 0;
                setText('breakEvenIncidents', breakEvenIncidents ? breakEvenIncidents.toLocaleString() : 'N/A');
                setText('annualIncidentsDisplay', annualIncidents.toString());

                const margin = annualIncidents > 0
                    ? Math.max(0, (annualIncidents - breakEvenIncidents) / annualIncidents)
                    : 0;
                setText('marginSafety', fmtPercent0(margin));

            } catch (e) {
                console.error('calculate() error:', e);
            }
        }

        // Run initial calc so Results tab is populated immediately
        calculate();
    </script>
</body>
</html>
